rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* =========================
       Helpers
       ========================= */

    function signedIn() {
      return request.auth != null;
    }

    function isSelf(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function isAdmin() {
      return request.auth != null
        && request.auth.token.admin == true;
    }

    function hasCanonUserKeys(d) {
      return d.keys().hasAll(["tier", "active", "role"]);
    }

    function canonImmutableUnchanged() {
      return request.resource.data.tier == resource.data.tier
          && request.resource.data.active == resource.data.active
          && request.resource.data.role == resource.data.role;
    }

    /* =========================
       USERS
       /users/{uid}
       ========================= */

    match /users/{uid} {

      // read own user doc
      allow read: if isSelf(uid) || isAdmin();

      // create own user doc with locked defaults
      allow create: if isSelf(uid)
        && hasCanonUserKeys(request.resource.data)
        && request.resource.data.tier == "free"
        && request.resource.data.active == true
        && request.resource.data.role == "user";

      // user may update profile/app only (tier/active/role frozen)
      // admin/webhook may update anything
      allow update: if (
          isSelf(uid)
          && canonImmutableUnchanged()
        )
        || isAdmin();

      // never delete
      allow delete: if false;
    }

    /* =========================
       PEACE THREADS
       ========================= */

    function threadDoc(threadId) {
      return get(/databases/$(database)/documents/threads/$(threadId));
    }

    function threadOwnerUids(threadId) {
      return threadDoc(threadId).data.ownerUids;
    }

    function isThreadMember(threadId) {
      return signedIn()
        && threadDoc(threadId).exists()
        && (request.auth.uid in threadOwnerUids(threadId));
    }

    match /threads/{threadId} {

      allow read: if isThreadMember(threadId);

      allow create: if signedIn()
        && (request.resource.data.ownerUids is list)
        && (request.resource.data.ownerUids.size() > 0)
        && (request.auth.uid in request.resource.data.ownerUids);

      allow update: if isThreadMember(threadId)
        && (request.resource.data.ownerUids == resource.data.ownerUids);

      allow delete: if false;

      match /messages/{messageId} {

        allow read: if isThreadMember(threadId);

        allow create: if isThreadMember(threadId)
          && request.resource.data.senderUid == request.auth.uid;

        allow update: if isThreadMember(threadId)
          && resource.data.senderUid == request.auth.uid
          && request.resource.data.senderUid == resource.data.senderUid;

        allow delete: if false;
      }
    }

    /* =========================
       DEFAULT DENY
       ========================= */

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
