rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    // Read thread doc for membership checks
    function threadDoc(threadId) {
      return get(/databases/$(database)/documents/threads/$(threadId));
    }

    function isThreadMember(threadId) {
      return signedIn()
        && (request.auth.uid in threadDoc(threadId).data.ownerUids);
    }

    // -------------------------
    // USERS
    // -------------------------
    match /users/{uid} {

      allow read: if isOwner(uid);

      allow create: if isOwner(uid);

      // Prevent client-side tier / active / role changes
      allow update: if isOwner(uid)
        && request.resource.data.tier == resource.data.tier
        && request.resource.data.active == resource.data.active
        && request.resource.data.role == resource.data.role;

      allow delete: if false;
    }

    // -------------------------
    // PEACE PATH THREADS
    // -------------------------
    match /threads/{threadId} {

      allow read: if signedIn()
        && request.auth.uid in resource.data.ownerUids;

      allow create: if signedIn()
        && request.resource.data.ownerUids is list
        && request.resource.data.ownerUids.size() > 0
        && request.auth.uid in request.resource.data.ownerUids;

      allow update: if signedIn()
        && request.auth.uid in resource.data.ownerUids
        && request.resource.data.ownerUids == resource.data.ownerUids;

      allow delete: if false;

      match /messages/{messageId} {

        allow read: if isThreadMember(threadId);

        allow create: if isThreadMember(threadId)
          && request.resource.data.senderUid == request.auth.uid;

        allow update: if isThreadMember(threadId)
          && resource.data.senderUid == request.auth.uid
          && request.resource.data.senderUid == resource.data.senderUid;

        allow delete: if false;
      }
    }

  }
}
