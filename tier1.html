<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sharpe Legal — Tier 1</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    .page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:40px 16px;}
    .box{max-width:920px;width:100%;background:var(--panel);border:1px solid var(--border);border-radius:18px;
      padding:26px;box-shadow:var(--shadow);}
    h1{margin:0 0 8px;font-size:30px;}
    .sub{color:var(--muted);margin:0 0 14px;line-height:1.45;}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px;}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr;}}
    .card{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:16px;}
    .price{font-size:26px;font-weight:900;margin:6px 0 10px;}
    ul{margin:8px 0 0;padding-left:18px;color:var(--muted);line-height:1.45;}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;align-items:center;}
    .btn{appearance:none;border:1px solid var(--border);border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:900;}
    .btn.primary{background:var(--accent);color:#071018;}
    .btn.secondary{background:transparent;color:var(--text);}
    .pill{display:inline-block;margin-top:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);color:var(--muted);font-size:12px;}
    .msg{margin-top:10px;color:var(--muted);min-height:20px;}
  </style>
</head>
<body>
  <main class="page">
    <section class="box">
      <h1>Sharpe Legal</h1>
      <p class="sub">
        Tier 1 is the “stop drowning” tier: structured intake + checklists + launchable templates.
        Payment is $10/month (Square). Tonight we’re shipping the healthy user flow.
      </p>

      <div class="grid">
        <div class="card">
          <div class="price">$10<span style="font-size:14px;color:var(--muted);font-weight:800;"> / month</span></div>
          <ul>
            <li>Guided intake that turns chaos into structured facts</li>
            <li>Task list: what to do next, in order</li>
            <li>Template starter pages (draft-ready scaffolds)</li>
            <li>Binder roadmap for judge-speed verification</li>
          </ul>

          <div class="row">
            <button id="continueBtn" class="btn primary" type="button">Continue</button>
            <button class="btn secondary" type="button" onclick="location.href='/'">Back to landing</button>
          </div>

          <div id="msg" class="msg"></div>
          <span class="pill">Continue routes by login + access</span>
        </div>

        <div class="card">
          <div style="font-weight:900;margin-bottom:6px;">First-time user path</div>
          <ul>
            <li>Landing page explains what this is</li>
            <li>Tier 1 page explains what they get</li>
            <li>App is gated by login + tier</li>
            <li>Billing automation comes later</li>
          </ul>
          <div class="row">
            <button class="btn secondary" type="button" onclick="location.href='/login.html?next=/app.html'">Log in directly</button>
            <button class="btn secondary" type="button" onclick="location.href='/subscribe.html'">Subscribe</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import app from "/firebase-config.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const auth = getAuth(app);
    const db = getFirestore(app);

    const btn = document.getElementById("continueBtn");
    const msg = document.getElementById("msg");

    function setMsg(t){ if (msg) msg.textContent = t || ""; }

    async function getAccess(uid){
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) return { active:false, tier:"" };
      const d = snap.data() || {};
      return { active: d.active === true, tier: d.tier || "" };
    }

    // Keep UI informative (optional)
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        setMsg("Not logged in. Continue will ask you to log in.");
        return;
      }
      try {
        const access = await getAccess(user.uid);
        setMsg(access.active ? "Access: ACTIVE" : "Access: not active yet (subscribe to unlock).");
      } catch {
        setMsg("Access: unable to read Firestore (check rules).");
      }
    });

    btn?.addEventListener("click", async () => {
      btn.disabled = true;
      setMsg("Checking access…");

      const user = auth.currentUser;
      if (!user) {
        // Not logged in -> login first
        window.location.href = "/login.html?next=/app.html";
        return;
      }

      try {
        const access = await getAccess(user.uid);

        if (access.active) {
          window.location.href = "/app.html";
          return;
        }

        // Logged in but not active -> subscribe
        window.location.href = "/subscribe.html";
      } catch (e) {
        console.log(e);
        setMsg("Access check failed. Redirecting to subscribe…");
        window.location.href = "/subscribe.html";
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
