/* /snapshot.js
   Snapshot (paid module) â€” canon compliant.

   Canon rules:
   - NO redirects for auth/tier (gate.js owns gating)
   - NO Firebase CDN imports
   - Auth state via getAuthStateOnce()
   - Firestore access ONLY via firebase-config exports
*/

import { getAuthStateOnce, getUserProfile, db, fsDoc, fsGetDoc } from "/firebase-config.js";

(function () {
  "use strict";

  function esc(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  function $(sel, root = document) {
    return root.querySelector(sel);
  }

  async function readUserSnapshot(uid) {
    // If you later add a dedicated doc (e.g. /users/{uid}/snapshots/main),
    // update here + firestore.rules accordingly.
    // For now, keep it minimal and safe:
    // - Profile from /users/{uid} (via getUserProfile)
    // - Optional: read a "snapshot" field from the same doc if present
    try {
      const ref = fsDoc(db, "users", uid);
      const snap = await fsGetDoc(ref);
      if (!snap.exists()) return {};
      const data = snap.data() || {};
      return (data.snapshot && typeof data.snapshot === "object") ? data.snapshot : {};
    } catch {
      return {};
    }
  }

  function render({ user, profile, snapshot }) {
    const box = $(".template-box") || document.body;

    const html = `
      <div class="card" style="padding:14px; margin-top:12px;">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div class="muted" style="font-size:13px;">Signed in as</div>
            <div style="font-weight:800;">${esc(user?.email || "(no email)")}</div>
          </div>
          <div class="badge" title="Profile tier">
            Tier: ${esc(profile?.tier || "free")}
          </div>
        </div>

        <div class="hr"></div>

        <div class="card" style="padding:12px;">
          <div class="muted" style="font-size:13px;">Snapshot</div>
          <div class="muted" style="margin-top:8px;">
            This module is live and canon-safe. Your actual Snapshot fields can be added incrementally
            once you decide the schema and update Firestore rules.
          </div>

          <div class="hr"></div>

          <div class="muted" style="font-size:13px;">Current saved snapshot payload</div>
          <pre style="margin-top:10px; white-space:pre-wrap; font-size:12px; color:var(--muted);">${esc(
            JSON.stringify(snapshot || {}, null, 2)
          )}</pre>
        </div>
      </div>
    `;

    // Replace the placeholder muted line if present.
    const placeholder = $(".muted", box);
    if (placeholder) placeholder.outerHTML = html;
    else box.insertAdjacentHTML("beforeend", html);
  }

  async function init() {
    try {
      const { user } = await getAuthStateOnce();
      if (!user) return; // gate.js handles auth redirect

      const [profile, snapshot] = await Promise.all([
        getUserProfile(user.uid).catch(() => ({})),
        readUserSnapshot(user.uid).catch(() => ({})),
      ]);

      render({ user, profile, snapshot });
    } catch (e) {
      console.error(e);
      const box = document.querySelector(".template-box") || document.body;
      box.insertAdjacentHTML(
        "beforeend",
        `<div class="alert warn" style="margin-top:12px;">Snapshot failed to load. Check console.</div>`
      );
    }
  }

  init();
})();
