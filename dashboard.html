<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Documents — SharpeSystem</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="ss-page">
  <header id="ss-header"></header>

  <main class="ss-container">
    <h1>My Documents</h1>

    <div class="ss-toolbar">
      <input id="searchBox" class="ss-input" placeholder="Search title, case, county…" />
    </div>

    <div id="loadingState" class="ss-muted">Loading…</div>

    <div id="errorState" class="ss-error" hidden></div>

    <div id="emptyState" class="ss-muted" hidden>
      No documents yet.
    </div>

    <div id="tableWrap" hidden>
      <table class="ss-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>Title</th>
            <th>Case #</th>
            <th>County</th>
            <th>Pages</th>
            <th>Created</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="jobsBody"></tbody>
      </table>
    </div>
  </main>

  <script type="module">
    import { getJobsStub } from "/scripts/jobs-stub.js";

    // ---------- DATA LAYER ----------
    async function fetchJobs() {
      // STUB MODE (swap this line later)
      return getJobsStub();

      // REAL MODE (API guy will own)
      // return await fetch("/api/jobs/list").then(r => r.json());
    }

    // ---------- RENDER ----------
    function renderJobsTable(jobs) {
      const tbody = document.getElementById("jobsBody");
      tbody.innerHTML = "";

      for (const j of jobs) {
        const tr = document.createElement("tr");

        const type = [j.flow, j.form].filter(Boolean).join(" / ") || "-";
        const title = j.title || "-";
        const caseNum = j.caseNumber || "-";
        const county = j.county || "-";
        const pages = j.pageCount ?? "-";
        const created = j.createdAt ? new Date(j.createdAt).toLocaleDateString() : "-";

        const printUrl = `/print.html?job=${encodeURIComponent(j.jobId)}`;

        tr.innerHTML = `
          <td>${type}</td>
          <td>${title}</td>
          <td>${caseNum}</td>
          <td>${county}</td>
          <td>${pages}</td>
          <td>${created}</td>
          <td class="ss-actions">
            <a class="ss-btn" href="${printUrl}">Print</a>
            ${j.downloadUrl ? `<a class="ss-btn" href="${j.downloadUrl}">Download</a>` : ``}
          </td>
        `;

        tbody.appendChild(tr);
      }
    }

    // ---------- FILTER ----------
    function filterJobs(jobs, q) {
      if (!q) return jobs;
      q = q.toLowerCase();
      return jobs.filter(j =>
        (j.title || "").toLowerCase().includes(q) ||
        (j.caseNumber || "").toLowerCase().includes(q) ||
        (j.county || "").toLowerCase().includes(q)
      );
    }

    // ---------- STATE ----------
    async function initDashboard() {
      const loading = document.getElementById("loadingState");
      const empty = document.getElementById("emptyState");
      const error = document.getElementById("errorState");
      const table = document.getElementById("tableWrap");
      const search = document.getElementById("searchBox");

      try {
        loading.hidden = false;
        const jobs = await fetchJobs();

        const sorted = [...jobs].sort(
          (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
        );

        loading.hidden = true;

        if (!sorted.length) {
          empty.hidden = false;
          return;
        }

        table.hidden = false;
        renderJobsTable(sorted);

        search.addEventListener("input", () => {
          const filtered = filterJobs(sorted, search.value);
          renderJobsTable(filtered);
        });

      } catch (e) {
        loading.hidden = true;
        error.hidden = false;
        error.textContent = "Failed to load documents.";
      }
    }

    initDashboard();
  </script>
</body>
</html>
