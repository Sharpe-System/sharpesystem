<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secure Checkout — SharpeSystem</title>
  <meta name="description" content="Secure SharpeSystem subscription checkout." />
  <link rel="stylesheet" href="/styles.css" />
  <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
</head>

<body class="shell">
  <div id="site-header"></div>

  <main class="page">
    <div class="container content">

      <section class="card" style="padding:var(--pad);border-radius:18px;">
        <h1>Secure Checkout</h1>
        <p class="muted">You’re unlocking Perfect Print export for this account.</p>

        <div class="hr"></div>

        <div class="card" style="padding:18px;border-radius:18px;">
          <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:12px;">
            <div>
              <div style="font-weight:800;">Selected tier</div>
              <div id="tierLabel" class="muted">basic</div>
            </div>
            <div>
              <div style="font-weight:800;">Price</div>
              <div id="priceLabel" class="muted">$—</div>
            </div>
          </div>

          <div class="hr"></div>

          <div>
            <div style="font-weight:800;margin-bottom:8px;">Payment</div>
            <div id="card-container"></div>
          </div>

          <div style="margin-top:16px;">
            <button id="payBtn" class="btn primary" style="padding:14px 18px;border-radius:18px;font-size:16px;">
              Pay Securely
            </button>
          </div>

          <p id="msg" class="muted" style="margin-top:10px;"></p>

          <p class="muted" style="margin-top:12px;">
            Perfect Print guarantees deterministic formatting fidelity for supported templates.
          </p>
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
          <a class="btn" style="border-radius:18px;" href="/pricing.html">Change plan</a>
          <a class="btn" style="border-radius:18px;" href="/billing.html">Billing</a>
          <a class="btn" style="border-radius:18px;" href="/">Home</a>
        </div>

      </section>

    </div>
  </main>

  <script>
    (function(){
      try{
        var u = new URL(window.location.href);
        var t = (u.searchParams.get("tier") || "basic").toLowerCase();
        var ok = (t === "basic" || t === "pro" || t === "attorney") ? t : "basic";
        var prices = { basic: "$—", pro: "$—", attorney: "Contact" };
        var tl = document.getElementById("tierLabel");
        var pl = document.getElementById("priceLabel");
        if (tl) tl.textContent = ok;
        if (pl) pl.textContent = prices[ok] || "$—";
      } catch(e){}
    })();
  </script>

  <script>
    async function initSquare() {
      var msg = document.getElementById("msg");
      var setMsg = function(t){ if (msg) msg.textContent = t || ""; };

      var cfgRes = await fetch("/api/square/config", { cache: "no-store" });
      var cfg = await cfgRes.json().catch(function(){ return null; });
      if (!cfgRes.ok || !cfg || !cfg.ok || !cfg.appId || !cfg.locationId) {
        setMsg("Square config missing.");
        return;
      }

      var payments = Square.payments(cfg.appId, cfg.locationId);
      var card = await payments.card();
      await card.attach("#card-container");

      var btn = document.getElementById("payBtn");
      if (!btn) return;

      btn.addEventListener("click", async function(){
        btn.disabled = true;
        setMsg("Tokenizing…");
        try {
          var result = await card.tokenize();
          if (result.status !== "OK") {
            setMsg("Card error.");
            btn.disabled = false;
            return;
          }
          console.log("Square token:", result.token);
          setMsg("Token OK. Next: charge endpoint.");
          btn.disabled = false;
        } catch (e) {
          console.log(e);
          setMsg("Payment init error.");
          btn.disabled = false;
        }
      });
    }

    initSquare();
  </script>

  <script src="/ui.js"></script>
  <script src="/header-loader.js"></script>
  <script src="/partials/header.js"></script>
  <script src="/i18n.js"></script>
  <script type="module" src="/gate.js"></script>
</body>
</html>
