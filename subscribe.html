<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Subscribe</title>

  <!-- Square SANDBOX SDK -->
  <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 24px; }
    h1 { margin: 0 0 12px; }
    #payment-form { max-width: 760px; }
    #card-container { border: 1px solid #ddd; border-radius: 8px; padding: 12px; }
    #card-button { margin-top: 12px; padding: 10px 14px; border-radius: 8px; border: 1px solid #111; background: #111; color: #fff; cursor: pointer; }
    #card-button[disabled] { opacity: 0.6; cursor: not-allowed; }
    #payment-status { margin-top: 12px; white-space: pre-wrap; }
    .hint { color: #555; margin: 12px 0 0; }
  </style>
</head>

<body>
  <h1>Subscribe to Sharpe Legal Premium</h1>

  <div id="payment-form">
    <div id="card-container"></div>
    <button id="card-button" type="button">Subscribe $10/month</button>
    <p id="payment-status"></p>
    <p class="hint">
      Sandbox testing: use 4111 1111 1111 1111, any future exp, any CVV, any ZIP.
    </p>
  </div>

  <script type="module">
    const $ = (id) => document.getElementById(id);

    const btn = $("card-button");
    const setStatus = (msg) => { $("payment-status").innerText = msg; };

    // ✅ SANDBOX App ID + SANDBOX Location ID
    const SQUARE_APP_ID = "sandbox-sq0idb-RT3u-HhCpNdbMiGg5aXuVg";
    const SQUARE_LOCATION_ID = "L06NC7MH9QAZR";

    // ✅ Your Cloudflare Worker endpoint
    const WORKER_URL = "https://sharpe-pay.nd-sharpe.workers.dev";

    // Use a fixed email for now (no Firebase/auth yet)
    const EMAIL = "test@example.com";

    // Init Square Payments + Card
    let card;
    try {
      const payments = Square.payments(SQUARE_APP_ID, SQUARE_LOCATION_ID);
      card = await payments.card();
      await card.attach("#card-container");
      setStatus("");
    } catch (e) {
      console.error(e);
      setStatus("Square init failed. Check console.");
      btn.disabled = true;
    }

    btn.addEventListener("click", async () => {
      if (!card) return;

      btn.disabled = true;

      try {
        setStatus("Tokenizing card...");
        const result = await card.tokenize();
        console.log("tokenize result:", result);

        if (result.status !== "OK") {
          setStatus("Card error. Check console.");
          return;
        }

        const token = String(result.token || "").trim();
        console.log("token prefix:", token.slice(0, 10), "len:", token.length);

        if (!token) {
          setStatus("No token returned. Check console.");
          return;
        }

        setStatus("Creating subscription...");

        const resp = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, email: EMAIL }),
        });

        const data = await resp.json().catch(() => ({}));
        console.log("worker response:", resp.status, data);

        if (!resp.ok || !data.success) {
          setStatus(
            "Subscription failed.\n" +
            "HTTP " + resp.status + "\n\n" +
            JSON.stringify(data, null, 2)
          );
          return;
        }

        setStatus(
          "✅ Subscription created.\n\n" +
          JSON.stringify(data, null, 2)
        );

        // Optional redirect later:
        // window.location.href = "/dashboard.html";
      } catch (e) {
        console.error(e);
        setStatus("Unexpected error. Check console.");
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
