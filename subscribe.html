<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Subscribe â€” SharpeSystem</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    .wrap{max-width:520px;margin:40px auto;padding:24px}
    #card-container{min-height:60px;margin:16px 0}
    #paySecurely{padding:12px 16px;font-size:16px}
    .error{color:#c00;margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Upgrade to Pro</h1>
    <div id="card-container"></div>
    <button id="paySecurely" disabled>Pay Securely</button>
    <div id="checkoutError" class="error"></div>
  </div>

  <script>
  async function loadSquareSdk(env){
    const src = env==="production"
      ? "https://web.squarecdn.com/v1/square.js"
      : "https://sandbox.web.squarecdn.com/v1/square.js";

    return new Promise((resolve,reject)=>{
      if(window.Square) return resolve();
      const s=document.createElement("script");
      s.src=src;
      s.async=true;
      s.onload=resolve;
      s.onerror=()=>reject(new Error("Square SDK load failed"));
      document.head.appendChild(s);
    });
  }

  async function initPayments(){
    const r = await fetch("/api/square/config",{credentials:"omit"});
    if(!r.ok) throw new Error("Config fetch failed "+r.status);
    const cfg = await r.json();

    if(!cfg || !cfg.appId || !cfg.locationId || !cfg.env){
      throw new Error("Invalid Square config");
    }

    await loadSquareSdk(cfg.env);

    const payments = window.Square.payments(cfg.appId,cfg.locationId);
    const card = await payments.card();
    await card.attach("#card-container");

    const btn = document.getElementById("paySecurely");
    btn.disabled=false;

    btn.addEventListener("click",async ()=>{
      const result = await card.tokenize();
      if(result.status!=="OK"){
        throw new Error(result.errors?.[0]?.message || "Tokenize failed");
      }
      console.log("Square token",result.token);
    });
  }

  document.addEventListener("DOMContentLoaded",()=>{
    initPayments().catch(e=>{
      console.error(e);
      const el=document.getElementById("checkoutError");
      if(el) el.textContent=e.message;
    });
  });
  </script>
</body>
</html>
