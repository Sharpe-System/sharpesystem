<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Subscribe</title>

  <!-- Square SANDBOX SDK -->
  <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 24px; }
    #card-container { max-width: 820px; }
    button { padding: 10px 14px; font-size: 16px; cursor: pointer; }
    #payment-status { margin-top: 12px; white-space: pre-wrap; }
  </style>
</head>

<body>
  <h1>Subscribe to Sharpe Legal Premium</h1>

  <div id="payment-form">
    <div id="card-container"></div>
    <button id="card-button" type="button" disabled>Subscribe $10/month</button>
    <p id="payment-status"></p>
  </div>

  <script type="module">
    const $ = (id) => document.getElementById(id);
    const setStatus = (msg) => { $("payment-status").textContent = msg; };

    // ---- REQUIRED: put YOUR sandbox App ID + sandbox Location ID here ----
    const SQUARE_APP_ID = "sandbox-sq0idb-RT3u-HhCpNdbMiGg5aXuVg";
    const SQUARE_LOCATION_ID = "L06NC7MH9QAZR";

    // ---- Your Worker endpoint (must accept POST) ----
    const WORKER_URL = "https://sharpe-pay.nd-sharpe.workers.dev";

    // ---- Email (no auth; just prompt) ----
    const email = window.prompt("Enter your email for the subscription:");
    if (!email) {
      setStatus("No email entered. Reload and try again.");
      throw new Error("Missing email");
    }

    // ---- Initialize Square Payments ----
    let payments;
    try {
      payments = Square.payments(SQUARE_APP_ID, SQUARE_LOCATION_ID);
    } catch (e) {
      setStatus("Square init failed. Check App ID / Location ID.\n\n" + (e?.message || e));
      throw e;
    }

    // ---- Build card ----
    let card;
    try {
      card = await payments.card();
      await card.attach("#card-container");
      $("card-button").disabled = false;
    } catch (e) {
      setStatus("Card UI failed to load.\n\n" + (e?.message || e));
      throw e;
    }

    // ---- Subscribe click ----
    $("card-button").addEventListener("click", async () => {
      $("card-button").disabled = true;

      try {
        setStatus("Tokenizing card...");
        const result = await card.tokenize();

        if (result.status !== "OK") {
          setStatus(
            "Card error:\n" +
            JSON.stringify(result, null, 2)
          );
          $("card-button").disabled = false;
          return;
        }

        setStatus("Creating subscription...");

        const res = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token: result.token, email })
        });

        // Worker might return non-JSON on misconfig; handle safely.
        let data = null;
        try { data = await res.json(); }
        catch { data = { error: "Non-JSON response from Worker" }; }

        if (!res.ok || !data?.success) {
          setStatus(
            "Subscription failed.\n" +
            "HTTP " + res.status + "\n\n" +
            JSON.stringify(data, null, 2)
          );
          $("card-button").disabled = false;
          return;
        }

        setStatus(
          "Subscription created!\n\n" +
          JSON.stringify(data, null, 2) +
          "\n\nRedirecting..."
        );

        setTimeout(() => { window.location.href = "/dashboard.html"; }, 800);

      } catch (err) {
        setStatus("Unexpected error:\n" + (err?.message || err));
        $("card-button").disabled = false;
      }
    });
  </script>
</body>
</html>
