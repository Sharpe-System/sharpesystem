// /login.js
// Canon rules:
// - NO Firebase CDN imports here (only /firebase-config.js may import Firebase CDN)
// - NO onAuthStateChanged here (must be only in /firebase-config.js)
// - gate.js owns gating/redirects; this page only performs sign-in and then navigates

import { authSignIn } from "/firebase-config.js";

(function () {
  "use strict";

  const $ = (sel) => document.querySelector(sel);

  const msg = $("#msg");
  const btnLogin = $("#btnLogin");
  const btnSignup = $("#btnSignup");

  const setMsg = (text, isError = false) => {
    if (!msg) return;
    msg.textContent = text || "";
    msg.style.color = isError ? "#ffb4b4" : "";
  };

  const getParam = (name) => {
    try {
      return new URLSearchParams(location.search).get(name);
    } catch (_) {
      return null;
    }
  };

  const safeNextUrl = () => {
    // gate.js passes `next` as a URL-encoded path. Only allow same-origin paths.
    const next = getParam("next");
    if (next && next.startsWith("/") && !next.startsWith("//")) return next;
    return "/dashboard.html";
  };

  const doLogin = async () => {
    const email = String($("#email")?.value || "").trim();
    const password = String($("#password")?.value || "");

    if (!email || !password) {
      setMsg("Email and password required.", true);
      return;
    }

    try {
      setMsg("Signing inâ€¦");
      btnLogin?.setAttribute("disabled", "disabled");
      await authSignIn(email, password);
      window.location.href = safeNextUrl();
    } catch (err) {
      console.error("Login failed", err);
      const code = err?.code ? String(err.code) : "";

      if (
        code.includes("auth/invalid-credential") ||
        code.includes("auth/wrong-password") ||
        code.includes("auth/user-not-found")
      ) {
        setMsg("Invalid email or password.", true);
      } else if (code.includes("auth/too-many-requests")) {
        setMsg("Too many attempts. Wait a bit and try again.", true);
      } else {
        const msgText = err?.message ? String(err.message) : "Login failed.";
        setMsg(code ? `${code}: ${msgText}` : msgText, true);
      }
    } finally {
      btnLogin?.removeAttribute("disabled");
    }
  };

  btnLogin?.addEventListener("click", doLogin);
  btnSignup?.addEventListener("click", () => (window.location.href = "/signup.html"));
  $("#password")?.addEventListener("keydown", (e) => {
    if (e.key === "Enter") doLogin();
  });
})();
